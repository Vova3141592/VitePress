# NekoRay

### Как установить?

1. Скачайте архив с файлами [отсюда](https://en.nekoray.org/download/).
2. Достаньте папку из архива. Положите её, например, на рабочий стол.
3. Откройте папку, найдите файл `nekoray.exe` и запустите его.

::::: tip Совет
Для удобства можно положить папку в незаметное место, а на рабочем столе сделать ярлык на файл `nekoray.exe`.
:::: details Как это сделать?
1. Положите папку в любое место, кроме рабочего стола.
2. Нажмите правой кнопкой мыши по рабочему столу.
3. Выберите «Создать» -> «Ярлык».
4. Укажите путь до файла `nekoray.exe`.
5. Введите красивое имя ярлыка, например «NekoRay».
::::
:::::

### Как настроить?

#### 1. При первом запуске программа попросит выбрать ядро:

![Ядро](/computer/nekoray.png)

Выберите «Xray».

::: details Почему?
VPN-сервер использует ядро Xray. Желательно, чтобы сервер и программа использовали одно и то же ядро: возможно, так будет стабильнее.
:::

#### 2. Появится оповещение межсетевого экрана Windows:

![Уведомление](/computer/nekoray2.png)

Нажмите «Разрешить доступ».

::: details Зачем?
Программа спросила, можно ли открывать любые порты на любых IP-адресах. Разрешите, чтобы она смогла работать.

Фактически, программа открывает 3 TCP-порта на IP-адресе `127.0.0.1`: `2080`, `2081` и ещё один со случайным номером.

Через первые два она принимает трафик от других программ и отправляет его на VPN-сервер. Третий нужен для управления ядром Xray.

Ничего страшного в том, чтобы разрешить доступ, нет: порты «слушают» на IP-адресе loopback-интерфейса, который находится внутри компьютера.

Даже если программа откроет порт на IP-адресе сетевого адаптера (она этого не делает, но права, которые она запрашивает, позволяют ей это сделать), ничего страшного не случится, ведь роутер по умолчанию отклоняет все входящие подключения из интернета.
:::

#### 3. Настройте раздельную маршрутизацию

Главное преимущество NekoRay перед [Hiddify](/computer/hiddify) — возможность подробно настроить маршрутизацию. Давайте это сделаем:

1. Нажмите «Настройки».
2. Нажмите «Настройки маршрутов».

![Маршрутизация](/computer/nekoray5.png)

3. Нажмите «Базовые маршруты».
4. Заполните табличку маршрутов:

|     |Напрямую                      |Прокси  |Блок|
|-----|------------------------------|--------|----|
|IP   |geoip:ru<br>geoip:private     |        |    |
|Домен|ru<br>xn--p1ai<br>su<br>vk.com|habr.com|    |

![Маршрутизация](/computer/nekoray6.png)

::: details Почему так?
В первом столбике мы записали признаки трафика, который пойдёт напрямую:
- IP-адреса назначения:
    - `geoip:ru` — трафик с российским IP-адресом назначения пойдёт напрямую.
    - `geoip:private` — трафик с частным IP-адресом назначения пойдёт напрямую. Например, до принтера в вашей локальной сети.
- Доменные имена:
    - `ru` — трафик до всех .ru-сайтов пойдёт напрямую. В табличке записывать нужно без точки.
    - `xn--p1ai` — это punycode-представление доменного имени `рф`. Поэтому трафик до всех .рф-сайтов пойдёт напрямую.
    - `su` — трафик до всех .su-сайтов пойдёт напрямую. Это доменное имя СССР, которое всё ещё используется некоторыми СНГ-сайтами.
    - `vk.com` — трафик до ВКонтакте пойдёт напрямую.

Во втором столбике мы записали признаки трафика, который пойдёт через VPN. На Хабре есть запрещённые статьи, поэтому трафик до него я пустил через VPN. У этого сайта российский IP-адрес, поэтому, согласно правилам из первого столбика, трафик должен идти напрямую. Но если явно указать доменное имя сайта во втором столбике, трафик пойдёт всё-таки через VPN.

В последнем столбике находятся сайты, к которым мы не должны подключаться вообще. Туда можно рекламу засунуть.

В нижнем правом углу находится правило по умолчанию. Если его не менять, весь трафик по умолчанию пойдёт через VPN (proxy).
:::

#### 4. Вставьте ссылку:

1. Скопируйте ссылку полностью с моей [страницы](https://vk.com/vova3141592) ВКонтакте.
2. Нажмите «Сервер».
3. Нажмите «Добавить профиль из буфера обмена».

![Ссылка](/computer/nekoray3.png)

#### 5. Подключитесь:

1. Нажмите правой кнопкой мыши по подключению.
2. Нажмите «Запустить».
3. Нажмите «Режим системного прокси».

![Подключение](/computer/nekoray4.png)

:::: details Почему режим системного прокси?
В режиме системного прокси NekoRay только «рекомендует» другим программам пускать трафик через себя. Но если программа не хочет или не умеет работать в таком режиме, она будет пускать трафик напрямую, в обход NekoRay. Для таких программ VPN работать не будет. Однако такой режим работает стабильнее, поэтому лучше использовать его. 

В режиме TUN NekoRay создаёт TUN-интерфейс и управляет им. Весь трафик идёт через этот интерфейс, поэтому NekoRay может управлять всем трафиком. Но для этого нужны права администратора, а ещё при закрытии программы можно забыть отключить TUN-интерфейс. В итоге TUN-интерфейс останется, а программа, которая им управляет, окажется выключена. В итоге интернет вообще пропадёт, пока вы снова программу не включите. Ещё в таком режиме почему-то некоторые DNS-запросы не отправляются. Поэтому лучше используйте режим системного прокси.
::::

#### 6. Проверьте подключение

Зайдите на [2ip.io](https://2ip.io/). Если местоположение определяется как Амстердам, тогда VPN работает!

![2ip.io](/computer/hiddify4.png)

Провертье правила маршрутизации. Зайдите на [2ip.ru](https://2ip.ru/) (доменное имя кончается на `.ru`). Местоположение должно определиться как Россия. Если определяется Россия, тогда маршрутизация работает!

![Подключение](/computer/nekoray7.png)

## Что дальше?

Если что-то не работает, смело [напишите](https://vk.com/vova3141592) мне. Разберёмся, в чём проблема.

Ещё настройте смартфон: [IPhone](/iphone/streisand.md), [Android](/android/hiddify.md).
